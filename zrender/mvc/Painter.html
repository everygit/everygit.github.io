<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Painter 类 | zrender 完全不指北</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="just a test desc">
    <link rel="preload" href="/zrender/assets/css/0.styles.501a54b0.css" as="style"><link rel="preload" href="/zrender/assets/js/app.67d98c5f.js" as="script"><link rel="preload" href="/zrender/assets/js/2.c8ceaaf2.js" as="script"><link rel="preload" href="/zrender/assets/js/30.0a698dd2.js" as="script"><link rel="prefetch" href="/zrender/assets/js/10.4ddc04a1.js"><link rel="prefetch" href="/zrender/assets/js/11.0e9e1a1e.js"><link rel="prefetch" href="/zrender/assets/js/12.42e9cee7.js"><link rel="prefetch" href="/zrender/assets/js/13.734a3ae1.js"><link rel="prefetch" href="/zrender/assets/js/14.cfa83a8d.js"><link rel="prefetch" href="/zrender/assets/js/15.59d6e2b9.js"><link rel="prefetch" href="/zrender/assets/js/16.41e08626.js"><link rel="prefetch" href="/zrender/assets/js/17.d16bd492.js"><link rel="prefetch" href="/zrender/assets/js/18.576f5719.js"><link rel="prefetch" href="/zrender/assets/js/19.e6bb86b0.js"><link rel="prefetch" href="/zrender/assets/js/20.1e5ed9f4.js"><link rel="prefetch" href="/zrender/assets/js/21.1a2b9260.js"><link rel="prefetch" href="/zrender/assets/js/22.d73f05bf.js"><link rel="prefetch" href="/zrender/assets/js/23.1ea0fe1b.js"><link rel="prefetch" href="/zrender/assets/js/24.8ec73bff.js"><link rel="prefetch" href="/zrender/assets/js/25.a5ec09f5.js"><link rel="prefetch" href="/zrender/assets/js/26.eff29809.js"><link rel="prefetch" href="/zrender/assets/js/27.3260f5ba.js"><link rel="prefetch" href="/zrender/assets/js/28.7f540414.js"><link rel="prefetch" href="/zrender/assets/js/29.fd2d0056.js"><link rel="prefetch" href="/zrender/assets/js/3.d7796f55.js"><link rel="prefetch" href="/zrender/assets/js/31.51647093.js"><link rel="prefetch" href="/zrender/assets/js/32.13d6a33e.js"><link rel="prefetch" href="/zrender/assets/js/33.d5534eaf.js"><link rel="prefetch" href="/zrender/assets/js/34.a38fef07.js"><link rel="prefetch" href="/zrender/assets/js/35.1f903498.js"><link rel="prefetch" href="/zrender/assets/js/36.58f04ae6.js"><link rel="prefetch" href="/zrender/assets/js/4.26ec334d.js"><link rel="prefetch" href="/zrender/assets/js/5.77f47214.js"><link rel="prefetch" href="/zrender/assets/js/6.5b21706c.js"><link rel="prefetch" href="/zrender/assets/js/7.5f0d5fec.js"><link rel="prefetch" href="/zrender/assets/js/8.afc32374.js"><link rel="prefetch" href="/zrender/assets/js/9.b63323df.js">
    <link rel="stylesheet" href="/zrender/assets/css/0.styles.501a54b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zrender/" class="home-link router-link-active"><!----> <span class="site-name">zrender 完全不指北</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Canvas 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SVG 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://ecomfe.github.io/zrender-doc/public/api.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ZRender 文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Canvas 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SVG 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://ecomfe.github.io/zrender-doc/public/api.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ZRender 文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>概述</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/" aria-current="page" class="sidebar-link">了解 zrender</a></li><li><a href="/zrender/summarize/" class="sidebar-link">为什么要看源码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/start/" class="sidebar-link">准备工作</a></li><li><a href="/zrender/start/DEV.html" class="sidebar-link">让代码飞一会</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>入口</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/flow/" class="sidebar-link">zrender 模块</a></li><li><a href="/zrender/flow/zrender_class.html" class="sidebar-link">Zrender 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MVC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/mvc/architecture.html" class="sidebar-link">架构</a></li><li><a href="/zrender/mvc/Storage.html" class="sidebar-link">Storage</a></li><li><a href="/zrender/mvc/Painter.html" aria-current="page" class="active sidebar-link">Painter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#构造函数" class="sidebar-link">构造函数</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#方法" class="sidebar-link">方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#gettype" class="sidebar-link">getType</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#issinglecanvas" class="sidebar-link">isSingleCanvas</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getviewportroot" class="sidebar-link">getViewportRoot</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getviewportrootoffset" class="sidebar-link">getViewportRootOffset</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#refresh" class="sidebar-link">refresh</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#addhover" class="sidebar-link">addHover</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#removehover" class="sidebar-link">removeHover</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#clearhover" class="sidebar-link">clearHover</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#refreshhover" class="sidebar-link">refreshHover</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#gethoverlayer" class="sidebar-link">getHoverLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#paintlist" class="sidebar-link">_paintList</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#compositemanually" class="sidebar-link">_compositeManually</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#dopaintlist" class="sidebar-link">_doPaintList</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#dopaintel" class="sidebar-link">_doPaintEl</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getlayer" class="sidebar-link">getLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#insertlayer" class="sidebar-link">insertLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#eachlayer" class="sidebar-link">eachLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#eachbuiltinlayer" class="sidebar-link">eachBuiltinLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#eachotherlayer" class="sidebar-link">eachOtherLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getlayers" class="sidebar-link">getLayers</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#updatelayerstatus" class="sidebar-link">_updateLayerStatus</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#clear" class="sidebar-link">clear</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#clearlayer" class="sidebar-link">_clearLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#setbackgroundcolor" class="sidebar-link">setBackgroundColor</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#configlayer" class="sidebar-link">configLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#dellayer" class="sidebar-link">delLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#resize" class="sidebar-link">resize</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#clearlayer-2" class="sidebar-link">clearLayer</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#dispose" class="sidebar-link">dispose</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getrenderedcanvas" class="sidebar-link">getRenderedCanvas</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getwidth" class="sidebar-link">getWidth</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getheight" class="sidebar-link">getHeight</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#getsize" class="sidebar-link">_getSize</a></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#pathtoimage" class="sidebar-link">pathToImage</a></li></ul></li><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#通用方法" class="sidebar-link">通用方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/mvc/Painter.html#isdisplayableculled" class="sidebar-link">isDisplayableCulled</a></li></ul></li></ul></li><li><a href="/zrender/mvc/Handler.html" class="sidebar-link">Handler</a></li><li><a href="/zrender/mvc/HandlerProxy.html" class="sidebar-link">HandlerProxy 类</a></li><li><a href="/zrender/mvc/Layer.html" class="sidebar-link">Layer 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>动画</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/animate/overview.html" class="sidebar-link">概述</a></li><li><a href="/zrender/animate/Animation.html" class="sidebar-link">Animation</a></li><li><a href="/zrender/animate/Animatable.html" class="sidebar-link">Animatable</a></li><li><a href="/zrender/animate/Animator.html" class="sidebar-link">Animator</a></li><li><a href="/zrender/animate/Clip.html" class="sidebar-link">Clip</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Displayable</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/display/overview.html" class="sidebar-link">概述</a></li><li><a href="/zrender/display/Displayable.html" class="sidebar-link">Displayable 类</a></li><li><a href="/zrender/display/Group.html" class="sidebar-link">Group 类</a></li><li><a href="/zrender/display/Element.html" class="sidebar-link">Element 类</a></li><li><a href="/zrender/display/Transformable.html" class="sidebar-link">Transformable 类</a></li><li><a href="/zrender/display/Eventful.html" class="sidebar-link">Eventful 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Graphic</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/graphic/Path.html" class="sidebar-link">Path 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构造器中的类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/cls/PathProxy.html" class="sidebar-link">PathProxy 类</a></li><li><a href="/zrender/cls/BoundingRect.html" class="sidebar-link">BoundingRect 类</a></li><li><a href="/zrender/cls/Draggable.html" class="sidebar-link">Draggable 类</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="painter-类"><a href="#painter-类" class="header-anchor">#</a> Painter 类</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>绘图工具，这里暂时只介绍 <code>canvas</code> 的绘图工具</p> <h2 id="构造函数"><a href="#构造函数" class="header-anchor">#</a> 构造函数</h2> <p>首先是 <code>type</code> 属性，这里指的是 <code>canvas</code> ，然后 <code>singleCanvas</code> ，以前一直不明白为什么要搞一个 <code>single</code> ，自从预研了微信小程序后，才发现这个特性非常的有用，并不是所有的使用场景都适合多层 <code>canvas</code> 。微信小程序中没有<code>DOM</code>，而<code>canvas</code>也是一个独立的组件，因此，只能使用 <code>singleCanvas</code>。</p> <p><code>zrender</code> 的 <code>devicePixelRatio</code>，只有在 <code>canvas</code> 中才会被支持，后面看具体的使用。</p> <p><code>_zlevelList</code> 存放所有的层级号，以备后期使用；<code>_layers</code> 中存在所有的层级；<code>_layerConfig</code> 前面提起过，用于配置重绘属性。</p> <p><code>_needsManuallyCompositing</code> 当根目录是一个画布并且有多个 <code>zlevel</code> 时，<code>zrender</code> 会进行合成</p> <p>如果是多层应用， 会创建一个 div 用来存放 canvas （可能是多个）</p> <p>如果是单层应用的话，会直接将当前的 canvas 进行处理，并创建 Layer</p> <h2 id="方法"><a href="#方法" class="header-anchor">#</a> 方法</h2> <h3 id="gettype"><a href="#gettype" class="header-anchor">#</a> <code>getType</code></h3> <p>返回 canvas ，对应于 svg 和 vml</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">getType</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'canvas'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="issinglecanvas"><a href="#issinglecanvas" class="header-anchor">#</a> <code>isSingleCanvas</code></h3> <p>是否单层应用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">isSingleCanvas</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_singleCanvas<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getviewportroot"><a href="#getviewportroot" class="header-anchor">#</a> <code>getViewportRoot</code></h3> <p>获取 <code>canvas</code> 的上层 <code>DOM</code> ，如果是单层应用的话，返回 <code>canvas</code> 标签</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">getViewportRoot</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_domRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getviewportrootoffset"><a href="#getviewportrootoffset" class="header-anchor">#</a> <code>getViewportRootOffset</code></h3> <p>获取 rootDom 的位置信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">getViewportRootOffset</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> viewportRoot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getViewportRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>viewportRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            offsetLeft<span class="token operator">:</span> viewportRoot<span class="token punctuation">.</span>offsetLeft <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
            offsetTop<span class="token operator">:</span> viewportRoot<span class="token punctuation">.</span>offsetTop <span class="token operator">||</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="refresh"><a href="#refresh" class="header-anchor">#</a> <code>refresh</code></h3> <p>刷新，这个地方比较核心</p> <p>关于 paintAll 为 true 的情况， 在 painter.resize 方法中尺寸发生变化后才会出现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">refresh</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">paintAll</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取所有可显示元素，并更新</span>
    <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">getDisplayList</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> zlevelList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_zlevelList<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_redrawId <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绘制所有元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_paintList</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> paintAll<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_redrawId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Paint custum layers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zlevelList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> z <span class="token operator">=</span> zlevelList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_layers<span class="token punctuation">[</span>z<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认情况下， layer 没有 refresh 方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>__builtin__ <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>refresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> clearColor <span class="token operator">=</span> i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_backgroundColor <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            layer<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span>clearColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshHover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="addhover"><a href="#addhover" class="header-anchor">#</a> <code>addHover</code></h3> <h3 id="removehover"><a href="#removehover" class="header-anchor">#</a> <code>removeHover</code></h3> <h3 id="clearhover"><a href="#clearhover" class="header-anchor">#</a> <code>clearHover</code></h3> <h3 id="refreshhover"><a href="#refreshhover" class="header-anchor">#</a> <code>refreshHover</code></h3> <h3 id="gethoverlayer"><a href="#gethoverlayer" class="header-anchor">#</a> <code>getHoverLayer</code></h3> <h3 id="paintlist"><a href="#paintlist" class="header-anchor">#</a> <code>_paintList</code></h3> <p>绘制所有的元素</p> <ul><li>list 要绘制的 displayable 列表</li> <li>paintAll 强制绘制所有displayable</li> <li>redrawId 重绘ID， 随机数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_paintList</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">,</span> paintAll<span class="token punctuation">,</span> redrawId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 防止重复调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_redrawId <span class="token operator">!==</span> redrawId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// </span>
    paintAll <span class="token operator">=</span> paintAll <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取层与元素的索引关系，以及是否需要更新</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateLayerStatus</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">var</span> finished <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_doPaintList</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> paintAll<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_needsManuallyCompositing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_compositeManually</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            self<span class="token punctuation">.</span><span class="token function">_paintList</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> paintAll<span class="token punctuation">,</span> redrawId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="compositemanually"><a href="#compositemanually" class="header-anchor">#</a> <code>_compositeManually</code></h3> <p>看方法的意思是将所有的层都绘制到同一个canvas， 看情况是用于单层应用，暂不理会。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_compositeManually</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token constant">CANVAS_ZLEVEL</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_domRoot<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_domRoot<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// PENDING, If only builtin layer?</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eachBuiltinLayer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>virtual<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>layer<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dopaintlist"><a href="#dopaintlist" class="header-anchor">#</a> <code>_doPaintList</code></h3> <p>挺长的，分解, 因为暂时不考虑 layer.incremental ， 所以剩下的流程就比较简单了。</p> <ul><li>获取需要更新的 layer</li> <li>遍历需要更新的 layer</li> <li>根据 layer 在所有元素中的索引，遍历所有的元素</li> <li>绘制每一个元素，然后将设置为不需要更新</li> <li>微信小程序（不是应该是单独的代码吗？）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_doPaintList</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">,</span> paintAll</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//todo</span>
<span class="token punctuation">}</span>
</code></pre></div><p>1.获取需要刷新的层</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> layerList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> zi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> zi <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_zlevelList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> zi<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> zlevel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_zlevelList<span class="token punctuation">[</span>zi<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_layers<span class="token punctuation">[</span>zlevel<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>__builtin__
        <span class="token operator">&amp;&amp;</span> layer <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_hoverlayer
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>__dirty <span class="token operator">||</span> paintAll<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layerList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.遍历需要刷新的层</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> layerList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> layer <span class="token operator">=</span> layerList<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctx <span class="token operator">=</span> layer<span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为不会使用 incremental 暂时认为两个值是一样的</span>
    <span class="token comment">// 获取元素中的开始索引</span>
    <span class="token keyword">var</span> start <span class="token operator">=</span> paintAll <span class="token operator">?</span> layer<span class="token punctuation">.</span>__startIndex <span class="token operator">:</span> layer<span class="token punctuation">.</span>__drawIndex<span class="token punctuation">;</span>

    <span class="token comment">// 暂不考虑</span>
    <span class="token keyword">var</span> useTimer <span class="token operator">=</span> <span class="token operator">!</span>paintAll <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>incremental <span class="token operator">&amp;&amp;</span> Date<span class="token punctuation">.</span>now<span class="token punctuation">;</span>
    <span class="token keyword">var</span> startTime <span class="token operator">=</span> useTimer <span class="token operator">&amp;&amp;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清除画布</span>
    <span class="token keyword">var</span> clearColor <span class="token operator">=</span> layer<span class="token punctuation">.</span>zlevel <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_zlevelList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_backgroundColor <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// All elements in this layer are cleared.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>__startIndex <span class="token operator">===</span> layer<span class="token punctuation">.</span>__endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> clearColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">===</span> layer<span class="token punctuation">.</span>__startIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> firstEl <span class="token operator">=</span> list<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firstEl<span class="token punctuation">.</span>incremental <span class="token operator">||</span> <span class="token operator">!</span>firstEl<span class="token punctuation">.</span>notClear <span class="token operator">||</span> paintAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> clearColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 暂时忽略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'For some unknown reason. drawIndex is -1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        start <span class="token operator">=</span> layer<span class="token punctuation">.</span>__startIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在这里 start 肯定是 __startIndex 了</span>
    <span class="token comment">// 遍历所有元素</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> layer<span class="token punctuation">.</span>__endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> el <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_doPaintEl</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> layer<span class="token punctuation">,</span> paintAll<span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        el<span class="token punctuation">.</span>__dirty <span class="token operator">=</span> el<span class="token punctuation">.</span>__dirtyText <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>useTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Date.now can be executed in 13,025,305 ops/second.</span>
            <span class="token keyword">var</span> dTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
            <span class="token comment">// Give 15 millisecond to draw.</span>
            <span class="token comment">// The rest elements will be drawn in the next frame.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dTime <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">&lt;</span> layer<span class="token punctuation">.</span>__endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        finished <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>scope<span class="token punctuation">.</span>prevElClipPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Needs restore the state. If last drawn element is in the clipping area.</span>
        ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3.微信小程序</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span>wxa<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush for weixin application</span>
    util<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_layers<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>ctx <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>draw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> finished<span class="token punctuation">;</span>
</code></pre></div><h3 id="dopaintel"><a href="#dopaintel" class="header-anchor">#</a> <code>_doPaintEl</code></h3> <p>绘制单个元素</p> <ul><li>el 元素</li> <li>currentLayer 绘制的 layer</li> <li>forcePaint 就是外面的 paintAll ， 暂不处理</li> <li>scope 作用域</li></ul> <p>绘制条件：</p> <ol><li>所属 <code>layer</code> 需要更新（或者 <code>paintAll</code> ，在 <code>IncrementalDisplayble</code> 中使用）</li> <li>元素必须可见</li> <li>元素的透明度不能为0</li> <li><code>scale</code> 不能为0， 会导致后续的错误</li> <li>元素未被剔除（是否进行裁剪）</li></ol> <p>关于 <code>el.culling</code> 属性，官方文档的解释是：是否进行裁剪， 必须在外部赋值，代码中没有任何的赋值的地方，<code>isDisplayableCulled</code> 方法后面研究</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_doPaintEl</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> currentLayer<span class="token punctuation">,</span> forcePaint<span class="token punctuation">,</span> scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ctx <span class="token operator">=</span> currentLayer<span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">var</span> m <span class="token operator">=</span> el<span class="token punctuation">.</span>transform<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>currentLayer<span class="token punctuation">.</span>__dirty <span class="token operator">||</span> forcePaint<span class="token punctuation">)</span>
        <span class="token comment">// Ignore invisible element</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>invisible
        <span class="token comment">// Ignore transparent element</span>
        <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>opacity <span class="token operator">!==</span> <span class="token number">0</span>
        <span class="token comment">// Ignore scale 0 element, in some environment like node-canvas</span>
        <span class="token comment">// Draw a scale 0 element can cause all following draw wrong</span>
        <span class="token comment">// And setTransform with scale 0 will cause set back transform failed.</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>m <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">// Ignore culled element</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>culling <span class="token operator">&amp;&amp;</span> <span class="token function">isDisplayableCulled</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">var</span> clipPaths <span class="token operator">=</span> el<span class="token punctuation">.</span>__clipPaths<span class="token punctuation">;</span>
        <span class="token keyword">var</span> prevElClipPaths <span class="token operator">=</span> scope<span class="token punctuation">.</span>prevElClipPaths<span class="token punctuation">;</span>

        <span class="token comment">// Optimize when clipping on group with several elements</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevElClipPaths <span class="token operator">||</span> <span class="token function">isClipPathChanged</span><span class="token punctuation">(</span>clipPaths<span class="token punctuation">,</span> prevElClipPaths<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If has previous clipping state, restore from it</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prevElClipPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                scope<span class="token punctuation">.</span>prevElClipPaths <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// Reset prevEl since context has been restored</span>
                scope<span class="token punctuation">.</span>prevEl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// New clipping state</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clipPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">doClip</span><span class="token punctuation">(</span>clipPaths<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                scope<span class="token punctuation">.</span>prevElClipPaths <span class="token operator">=</span> clipPaths<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        el<span class="token punctuation">.</span>beforeBrush <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span><span class="token function">beforeBrush</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        el<span class="token punctuation">.</span><span class="token function">brush</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> scope<span class="token punctuation">.</span>prevEl <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope<span class="token punctuation">.</span>prevEl <span class="token operator">=</span> el<span class="token punctuation">;</span>

        el<span class="token punctuation">.</span>afterBrush <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span><span class="token function">afterBrush</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getlayer"><a href="#getlayer" class="header-anchor">#</a> <code>getLayer</code></h3> <h3 id="insertlayer"><a href="#insertlayer" class="header-anchor">#</a> <code>insertLayer</code></h3> <h3 id="eachlayer"><a href="#eachlayer" class="header-anchor">#</a> <code>eachLayer</code></h3> <h3 id="eachbuiltinlayer"><a href="#eachbuiltinlayer" class="header-anchor">#</a> <code>eachBuiltinLayer</code></h3> <h3 id="eachotherlayer"><a href="#eachotherlayer" class="header-anchor">#</a> <code>eachOtherLayer</code></h3> <h3 id="getlayers"><a href="#getlayers" class="header-anchor">#</a> <code>getLayers</code></h3> <p>获取 zlevel 所在层，如果不存在则会创建一个新的层</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">getLayer</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">zlevel<span class="token punctuation">,</span> virtual</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_singleCanvas <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_needsManuallyCompositing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        zlevel <span class="token operator">=</span> <span class="token constant">CANVAS_ZLEVEL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_layers<span class="token punctuation">[</span>zlevel<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create a new layer</span>
        layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span><span class="token string">'zr_'</span> <span class="token operator">+</span> zlevel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        layer<span class="token punctuation">.</span>zlevel <span class="token operator">=</span> zlevel<span class="token punctuation">;</span>
        layer<span class="token punctuation">.</span>__builtin__ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_layerConfig<span class="token punctuation">[</span>zlevel<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            util<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>layer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_layerConfig<span class="token punctuation">[</span>zlevel<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO Remove EL_AFTER_INCREMENTAL_INC magic number</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_layerConfig<span class="token punctuation">[</span>zlevel <span class="token operator">-</span> <span class="token constant">EL_AFTER_INCREMENTAL_INC</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            util<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>layer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_layerConfig<span class="token punctuation">[</span>zlevel <span class="token operator">-</span> <span class="token constant">EL_AFTER_INCREMENTAL_INC</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// incremental 的时候才会使用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>virtual<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span>virtual <span class="token operator">=</span> virtual<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertLayer</span><span class="token punctuation">(</span>zlevel<span class="token punctuation">,</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Context is created after dom inserted to document</span>
        <span class="token comment">// Or excanvas will get 0px clientWidth and clientHeight</span>
        layer<span class="token punctuation">.</span><span class="token function">initContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> layer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="updatelayerstatus"><a href="#updatelayerstatus" class="header-anchor">#</a> <code>_updateLayerStatus</code></h3> <p>更新层状态， 这里有点复杂， 将代码分解吧</p> <p>大体功能，将元素分配到层中，并且确定层是否需要更新</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_updateLayerStatus</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo </span>
<span class="token punctuation">}</span>
</code></pre></div><p>1.所有层的数据初始化</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eachBuiltinLayer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    layer<span class="token punctuation">.</span>__dirty <span class="token operator">=</span> layer<span class="token punctuation">.</span>__used <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>2.单层应用处理</p> <p>如果只有一个 <code>canvas</code> 然后元素还添加在很多层中，需要合并所有的元素到一个 <code>canvas</code> 上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_singleCanvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> el <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>zlevel <span class="token operator">!==</span> list<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zlevel <span class="token operator">||</span> el<span class="token punctuation">.</span>incremental<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_needsManuallyCompositing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3.遍历所有元素</p> <p>关于 <code>incremental</code> 属性， 是 <code>IncrementalDisplayble</code> 类中所有，<code>IncrementalDisplayble</code> 像是一个容器，类似于 <code>Group</code> 吧，应该是在循环中增加元素时，会比 <code>Group</code> 的性能相对高很多，暂不分析了，碰到这个属性先暂时过吧</p> <p>遍历所有的元素，然后分配到各个层中，每个层会获得元素列表的开始和结束索引，并且以元素是否需要更新来判定</p> <blockquote><p>使用案例： test\incremental.html</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> prevLayer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> incrementalLayerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> prevZlevel<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> el <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> zlevel <span class="token operator">=</span> el<span class="token punctuation">.</span>zlevel<span class="token punctuation">;</span>
    <span class="token keyword">var</span> layer<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevZlevel <span class="token operator">!==</span> zlevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prevZlevel <span class="token operator">=</span> zlevel<span class="token punctuation">;</span>
        incrementalLayerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 第一个条件分支暂不考虑， 那么这里将调用 this.getLayer 方法</span>
    <span class="token comment">// 如果已经存在则直接返回，如果不存在将创建 Layer</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>incremental<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span>zlevel <span class="token operator">+</span> <span class="token constant">INCREMENTAL_INC</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_needsManuallyCompositing<span class="token punctuation">)</span><span class="token punctuation">;</span>
        layer<span class="token punctuation">.</span>incremental <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        incrementalLayerCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span>
            zlevel <span class="token operator">+</span> <span class="token punctuation">(</span>incrementalLayerCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">EL_AFTER_INCREMENTAL_INC</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_needsManuallyCompositing
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在 Layer 实例化后， 会赋值 __builtin__ 为 true</span>
    <span class="token comment">// 为什么会 false 呢？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>__builtin__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logError</span><span class="token punctuation">(</span><span class="token string">'ZLevel '</span> <span class="token operator">+</span> zlevel <span class="token operator">+</span> <span class="token string">' has been used by unkown layer '</span> <span class="token operator">+</span> layer<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 所有的元素是根据层级排过序的，所以出现改条件，说明进入了新的层级</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer <span class="token operator">!==</span> prevLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layer<span class="token punctuation">.</span>__used <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>__startIndex <span class="token operator">!==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span>__dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        layer<span class="token punctuation">.</span>__startIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>incremental<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 绘制索引？</span>
            layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Mark layer draw index needs to update.</span>
            layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 处理上一个层</span>
        <span class="token function">updatePrevLayer</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        prevLayer <span class="token operator">=</span> layer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果一个层中的某个元素需要更新，则整个层都需要更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>__dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layer<span class="token punctuation">.</span>__dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>incremental <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Start draw from the first dirty element.</span>
            layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 收尾</span>
<span class="token function">updatePrevLayer</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updatePrevLayer</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevLayer<span class="token punctuation">.</span>__endIndex <span class="token operator">!==</span> idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            prevLayer<span class="token punctuation">.</span>__dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prevLayer<span class="token punctuation">.</span>__endIndex <span class="token operator">=</span> idx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>4.异常处理</p> <p>瞎猜的，也没有调试出现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eachBuiltinLayer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Used in last frame but not in this frame. Needs clear</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>__used <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span><span class="token function">getElementCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layer<span class="token punctuation">.</span>__dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        layer<span class="token punctuation">.</span>__startIndex <span class="token operator">=</span> layer<span class="token punctuation">.</span>__endIndex <span class="token operator">=</span> layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// For incremental layer. In case start index changed and no elements are dirty.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>__dirty <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layer<span class="token punctuation">.</span>__drawIndex <span class="token operator">=</span> layer<span class="token punctuation">.</span>__startIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="clear"><a href="#clear" class="header-anchor">#</a> <code>clear</code></h3> <h3 id="clearlayer"><a href="#clearlayer" class="header-anchor">#</a> <code>_clearLayer</code></h3> <h3 id="setbackgroundcolor"><a href="#setbackgroundcolor" class="header-anchor">#</a> <code>setBackgroundColor</code></h3> <h3 id="configlayer"><a href="#configlayer" class="header-anchor">#</a> <code>configLayer</code></h3> <h3 id="dellayer"><a href="#dellayer" class="header-anchor">#</a> <code>delLayer</code></h3> <h3 id="resize"><a href="#resize" class="header-anchor">#</a> <code>resize</code></h3> <h3 id="clearlayer-2"><a href="#clearlayer-2" class="header-anchor">#</a> <code>clearLayer</code></h3> <h3 id="dispose"><a href="#dispose" class="header-anchor">#</a> <code>dispose</code></h3> <h3 id="getrenderedcanvas"><a href="#getrenderedcanvas" class="header-anchor">#</a> <code>getRenderedCanvas</code></h3> <h3 id="getwidth"><a href="#getwidth" class="header-anchor">#</a> <code>getWidth</code></h3> <h3 id="getheight"><a href="#getheight" class="header-anchor">#</a> <code>getHeight</code></h3> <h3 id="getsize"><a href="#getsize" class="header-anchor">#</a> <code>_getSize</code></h3> <h3 id="pathtoimage"><a href="#pathtoimage" class="header-anchor">#</a> <code>pathToImage</code></h3> <h2 id="通用方法"><a href="#通用方法" class="header-anchor">#</a> 通用方法</h2> <h3 id="isdisplayableculled"><a href="#isdisplayableculled" class="header-anchor">#</a> <code>isDisplayableCulled</code></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> tmpRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoundingRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> viewRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoundingRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">isDisplayableCulled</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tmpRect<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token function">getBoundingRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>transform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tmpRect<span class="token punctuation">.</span><span class="token function">applyTransform</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    viewRect<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    viewRect<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>tmpRect<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>viewRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zrender/mvc/Storage.html" class="prev">
        Storage
      </a></span> <span class="next"><a href="/zrender/mvc/Handler.html">
        Handler
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/zrender/assets/js/app.67d98c5f.js" defer></script><script src="/zrender/assets/js/2.c8ceaaf2.js" defer></script><script src="/zrender/assets/js/30.0a698dd2.js" defer></script>
  </body>
</html>
