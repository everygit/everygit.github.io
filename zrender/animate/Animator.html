<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Animator 类 | zrender 完全不指北</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="just a test desc">
    <link rel="preload" href="/zrender/assets/css/0.styles.501a54b0.css" as="style"><link rel="preload" href="/zrender/assets/js/app.67d98c5f.js" as="script"><link rel="preload" href="/zrender/assets/js/2.c8ceaaf2.js" as="script"><link rel="preload" href="/zrender/assets/js/10.4ddc04a1.js" as="script"><link rel="prefetch" href="/zrender/assets/js/11.0e9e1a1e.js"><link rel="prefetch" href="/zrender/assets/js/12.42e9cee7.js"><link rel="prefetch" href="/zrender/assets/js/13.734a3ae1.js"><link rel="prefetch" href="/zrender/assets/js/14.cfa83a8d.js"><link rel="prefetch" href="/zrender/assets/js/15.59d6e2b9.js"><link rel="prefetch" href="/zrender/assets/js/16.41e08626.js"><link rel="prefetch" href="/zrender/assets/js/17.d16bd492.js"><link rel="prefetch" href="/zrender/assets/js/18.576f5719.js"><link rel="prefetch" href="/zrender/assets/js/19.e6bb86b0.js"><link rel="prefetch" href="/zrender/assets/js/20.1e5ed9f4.js"><link rel="prefetch" href="/zrender/assets/js/21.1a2b9260.js"><link rel="prefetch" href="/zrender/assets/js/22.d73f05bf.js"><link rel="prefetch" href="/zrender/assets/js/23.1ea0fe1b.js"><link rel="prefetch" href="/zrender/assets/js/24.8ec73bff.js"><link rel="prefetch" href="/zrender/assets/js/25.a5ec09f5.js"><link rel="prefetch" href="/zrender/assets/js/26.eff29809.js"><link rel="prefetch" href="/zrender/assets/js/27.3260f5ba.js"><link rel="prefetch" href="/zrender/assets/js/28.7f540414.js"><link rel="prefetch" href="/zrender/assets/js/29.fd2d0056.js"><link rel="prefetch" href="/zrender/assets/js/3.d7796f55.js"><link rel="prefetch" href="/zrender/assets/js/30.0a698dd2.js"><link rel="prefetch" href="/zrender/assets/js/31.51647093.js"><link rel="prefetch" href="/zrender/assets/js/32.13d6a33e.js"><link rel="prefetch" href="/zrender/assets/js/33.d5534eaf.js"><link rel="prefetch" href="/zrender/assets/js/34.a38fef07.js"><link rel="prefetch" href="/zrender/assets/js/35.1f903498.js"><link rel="prefetch" href="/zrender/assets/js/36.58f04ae6.js"><link rel="prefetch" href="/zrender/assets/js/4.26ec334d.js"><link rel="prefetch" href="/zrender/assets/js/5.77f47214.js"><link rel="prefetch" href="/zrender/assets/js/6.5b21706c.js"><link rel="prefetch" href="/zrender/assets/js/7.5f0d5fec.js"><link rel="prefetch" href="/zrender/assets/js/8.afc32374.js"><link rel="prefetch" href="/zrender/assets/js/9.b63323df.js">
    <link rel="stylesheet" href="/zrender/assets/css/0.styles.501a54b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zrender/" class="home-link router-link-active"><!----> <span class="site-name">zrender 完全不指北</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Canvas 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SVG 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://ecomfe.github.io/zrender-doc/public/api.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ZRender 文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Canvas 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SVG 教程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://ecomfe.github.io/zrender-doc/public/api.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ZRender 文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>概述</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/" aria-current="page" class="sidebar-link">了解 zrender</a></li><li><a href="/zrender/summarize/" class="sidebar-link">为什么要看源码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/start/" class="sidebar-link">准备工作</a></li><li><a href="/zrender/start/DEV.html" class="sidebar-link">让代码飞一会</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>入口</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/flow/" class="sidebar-link">zrender 模块</a></li><li><a href="/zrender/flow/zrender_class.html" class="sidebar-link">Zrender 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MVC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/mvc/architecture.html" class="sidebar-link">架构</a></li><li><a href="/zrender/mvc/Storage.html" class="sidebar-link">Storage</a></li><li><a href="/zrender/mvc/Painter.html" class="sidebar-link">Painter</a></li><li><a href="/zrender/mvc/Handler.html" class="sidebar-link">Handler</a></li><li><a href="/zrender/mvc/HandlerProxy.html" class="sidebar-link">HandlerProxy 类</a></li><li><a href="/zrender/mvc/Layer.html" class="sidebar-link">Layer 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>动画</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/animate/overview.html" class="sidebar-link">概述</a></li><li><a href="/zrender/animate/Animation.html" class="sidebar-link">Animation</a></li><li><a href="/zrender/animate/Animatable.html" class="sidebar-link">Animatable</a></li><li><a href="/zrender/animate/Animator.html" aria-current="page" class="active sidebar-link">Animator</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#构造函数" class="sidebar-link">构造函数</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#字段" class="sidebar-link">字段</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#tracks" class="sidebar-link">_tracks</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#target" class="sidebar-link">_target</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#loop" class="sidebar-link">_loop</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#getter" class="sidebar-link">_getter</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#setter" class="sidebar-link">_setter</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#clipcount" class="sidebar-link">_clipCount</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#delay" class="sidebar-link">_delay</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#donelist" class="sidebar-link">_doneList</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#onframelist" class="sidebar-link">_onframeList</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#cliplist" class="sidebar-link">_clipList</a></li></ul></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#方法" class="sidebar-link">方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#when" class="sidebar-link">when</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#during" class="sidebar-link">during</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#pause" class="sidebar-link">pause</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#resume" class="sidebar-link">resume</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#ispaused" class="sidebar-link">isPaused</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#donecallback" class="sidebar-link">_doneCallback</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#start" class="sidebar-link">start</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#stop" class="sidebar-link">stop</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#delay-2" class="sidebar-link">delay</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#done" class="sidebar-link">done</a></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#getclips" class="sidebar-link">getClips</a></li></ul></li><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#通用方法" class="sidebar-link">通用方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zrender/animate/Animator.html#createtrackclip" class="sidebar-link">createTrackClip</a></li></ul></li></ul></li><li><a href="/zrender/animate/Clip.html" class="sidebar-link">Clip</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Displayable</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/display/overview.html" class="sidebar-link">概述</a></li><li><a href="/zrender/display/Displayable.html" class="sidebar-link">Displayable 类</a></li><li><a href="/zrender/display/Group.html" class="sidebar-link">Group 类</a></li><li><a href="/zrender/display/Element.html" class="sidebar-link">Element 类</a></li><li><a href="/zrender/display/Transformable.html" class="sidebar-link">Transformable 类</a></li><li><a href="/zrender/display/Eventful.html" class="sidebar-link">Eventful 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Graphic</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/graphic/Path.html" class="sidebar-link">Path 类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构造器中的类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zrender/cls/PathProxy.html" class="sidebar-link">PathProxy 类</a></li><li><a href="/zrender/cls/BoundingRect.html" class="sidebar-link">BoundingRect 类</a></li><li><a href="/zrender/cls/Draggable.html" class="sidebar-link">Draggable 类</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="animator-类"><a href="#animator-类" class="header-anchor">#</a> Animator 类</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>动画对象</p> <h2 id="构造函数"><a href="#构造函数" class="header-anchor">#</a> 构造函数</h2> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>target</td> <td>Object</td> <td>是指 style 或 shape 中所有的值</td></tr> <tr><td>loop</td> <td>Boolean</td> <td>是否循环播放</td></tr> <tr><td>getter</td> <td>Function</td> <td>从 target 中获取数据的方法</td></tr> <tr><td>setter</td> <td>Function</td> <td>为 target 赋值的方法</td></tr></tbody></table> <h2 id="字段"><a href="#字段" class="header-anchor">#</a> 字段</h2> <h3 id="tracks"><a href="#tracks" class="header-anchor">#</a> <code>_tracks</code></h3> <p>动画轨迹， 在 when 方法执行时，会加入开始和结束的时间轴和值</p> <h3 id="target"><a href="#target" class="header-anchor">#</a> <code>_target</code></h3> <p>style 或 shape 具体的值</p> <h3 id="loop"><a href="#loop" class="header-anchor">#</a> <code>_loop</code></h3> <p>是否循环播放</p> <h3 id="getter"><a href="#getter" class="header-anchor">#</a> <code>_getter</code></h3> <p>从 this._target 中获取数据的方法</p> <h3 id="setter"><a href="#setter" class="header-anchor">#</a> <code>_setter</code></h3> <p>想 this._target 中写入数据的方法</p> <h3 id="clipcount"><a href="#clipcount" class="header-anchor">#</a> <code>_clipCount</code></h3> <p>好尴尬啊~，只有声明，没有引用，看定义是私有变量</p> <h3 id="delay"><a href="#delay" class="header-anchor">#</a> <code>_delay</code></h3> <p>动画延迟时间</p> <h3 id="donelist"><a href="#donelist" class="header-anchor">#</a> <code>_doneList</code></h3> <p>动画执行结束后的回调函数集合</p> <h3 id="onframelist"><a href="#onframelist" class="header-anchor">#</a> <code>_onframeList</code></h3> <p>动画执行期间的回调函数集合</p> <h3 id="cliplist"><a href="#cliplist" class="header-anchor">#</a> <code>_clipList</code></h3> <p>动画剪辑集合</p> <h2 id="方法"><a href="#方法" class="header-anchor">#</a> 方法</h2> <h3 id="when"><a href="#when" class="header-anchor">#</a> <code>when</code></h3> <p>定义关键帧，即动画对象在某个时刻的属性。</p> <p>创建动画轨迹, when 可能会多次使用</p> <blockquote><p>tracks 在使用的时候会排序， 所以多个 when 增加的关键帧不需要考虑时间轴的大小顺序</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">when</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> tracks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_tracks<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tracks<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tracks<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_target<span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tracks<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    time<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    value<span class="token operator">:</span> <span class="token function">cloneValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        tracks<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            time<span class="token operator">:</span> time<span class="token punctuation">,</span>
            value<span class="token operator">:</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="during"><a href="#during" class="header-anchor">#</a> <code>during</code></h3> <p>为关键帧添加回调函数，在关键帧运行后执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">during</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_onframeList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="pause"><a href="#pause" class="header-anchor">#</a> <code>pause</code></h3> <p>暂停动画。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">pause</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_paused <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="resume"><a href="#resume" class="header-anchor">#</a> <code>resume</code></h3> <p>恢复动画。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">resume</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ispaused"><a href="#ispaused" class="header-anchor">#</a> <code>isPaused</code></h3> <p>获得动画是否处于暂停状态。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">isPaused</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_paused<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="donecallback"><a href="#donecallback" class="header-anchor">#</a> <code>_doneCallback</code></h3> <p>??</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_doneCallback</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Clear all tracks</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_tracks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear all clips</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> doneList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_doneList<span class="token punctuation">;</span>
        <span class="token keyword">var</span> len <span class="token operator">=</span> doneList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            doneList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="start"><a href="#start" class="header-anchor">#</a> <code>start</code></h3> <p>开始执行动画。</p> <p>创建动画剪辑并且添加到 animation 中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">easing<span class="token punctuation">,</span> forceAnimate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> clipCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token function-variable function">oneTrackDone</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clipCount<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clipCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            self<span class="token punctuation">.</span><span class="token function">_doneCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> lastClip<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> propName <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_tracks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_tracks<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> clip <span class="token operator">=</span> <span class="token function">createTrackClip</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span> easing<span class="token punctuation">,</span> oneTrackDone<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_tracks<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">,</span> propName<span class="token punctuation">,</span> forceAnimate
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>clip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            clipCount<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>animation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>animation<span class="token punctuation">.</span><span class="token function">addClip</span><span class="token punctuation">(</span>clip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            lastClip <span class="token operator">=</span> clip<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastClip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> oldOnFrame <span class="token operator">=</span> lastClip<span class="token punctuation">.</span>onframe<span class="token punctuation">;</span>
        lastClip<span class="token punctuation">.</span><span class="token function-variable function">onframe</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> percent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>percent<span class="token punctuation">,</span> percent<span class="token punctuation">)</span>
            <span class="token function">oldOnFrame</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> percent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>_onframeList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                self<span class="token punctuation">.</span>_onframeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> percent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clipCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_doneCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="stop"><a href="#stop" class="header-anchor">#</a> <code>stop</code></h3> <p>停止动画。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">stop</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">forwardToLast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> clipList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">;</span>
    <span class="token keyword">var</span> animation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animation<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> clipList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> clip <span class="token operator">=</span> clipList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forwardToLast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            clip<span class="token punctuation">.</span><span class="token function">onframe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_target<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        animation <span class="token operator">&amp;&amp;</span> animation<span class="token punctuation">.</span><span class="token function">removeClip</span><span class="token punctuation">(</span>clip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    clipList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="delay-2"><a href="#delay-2" class="header-anchor">#</a> <code>delay</code></h3> <p>设置动画延迟开始的时间。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">delay</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_delay <span class="token operator">=</span> time<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="done"><a href="#done" class="header-anchor">#</a> <code>done</code></h3> <p>设置动画结束的回调函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">done</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_doneList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getclips"><a href="#getclips" class="header-anchor">#</a> <code>getClips</code></h3> <p>获取所有的 Clip</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">getClips</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_clipList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="通用方法"><a href="#通用方法" class="header-anchor">#</a> 通用方法</h2> <h3 id="createtrackclip"><a href="#createtrackclip" class="header-anchor">#</a> <code>createTrackClip</code></h3> <p>创建动画剪辑, 并定义每一帧需要计算值的方法 onframe</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>animator</td> <td>Animator</td> <td>动画对象</td></tr> <tr><td>easing</td> <td>String</td> <td>缓动效果名称</td></tr> <tr><td>oneTrackDone</td> <td>Function</td> <td>Clip 调用 ondestroy 时的回调函数</td></tr> <tr><td>keyframes</td> <td>Object[]</td> <td>关键帧</td></tr> <tr><td>propName</td> <td>String</td> <td>属性名称，用于描述关键帧或者动画剪辑</td></tr> <tr><td>forceAnimate</td> <td>Boolean</td> <td>强制动画</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createTrackClip</span><span class="token punctuation">(</span><span class="token parameter">animator<span class="token punctuation">,</span> easing<span class="token punctuation">,</span> oneTrackDone<span class="token punctuation">,</span> keyframes<span class="token punctuation">,</span> propName<span class="token punctuation">,</span> forceAnimate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 见下面</span>
<span class="token punctuation">}</span>
</code></pre></div><p>简单赋值、判断等</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> getter <span class="token operator">=</span> animator<span class="token punctuation">.</span>_getter<span class="token punctuation">;</span>
<span class="token keyword">var</span> setter <span class="token operator">=</span> animator<span class="token punctuation">.</span>_setter<span class="token punctuation">;</span>
<span class="token keyword">var</span> useSpline <span class="token operator">=</span> easing <span class="token operator">===</span> <span class="token string">'spline'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> trackLen <span class="token operator">=</span> keyframes<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trackLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不深入研究，暂时认为不是数组。所以下面的代码在尝试值的类型，以及获取时间轴上的最大值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 时间轴的第一个值</span>
<span class="token keyword">var</span> firstVal <span class="token operator">=</span> keyframes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token comment">// 判断是否为数组或类似数组</span>
<span class="token keyword">var</span> isValueArray <span class="token operator">=</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span>firstVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 是不是颜色值</span>
<span class="token keyword">var</span> isValueColor <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 是否字符串</span>
<span class="token keyword">var</span> isValueString <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 暂时不考虑， 默认为 0</span>
<span class="token keyword">var</span> arrDim <span class="token operator">=</span> isValueArray <span class="token operator">?</span> <span class="token function">getArrayDim</span><span class="token punctuation">(</span>keyframes<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 获取时间轴的最大值</span>
<span class="token keyword">var</span> trackMaxTime<span class="token punctuation">;</span>
<span class="token comment">// Sort keyframe as ascending</span>
keyframes<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a<span class="token punctuation">.</span>time <span class="token operator">-</span> b<span class="token punctuation">.</span>time<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trackMaxTime <span class="token operator">=</span> keyframes<span class="token punctuation">[</span>trackLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">;</span>
</code></pre></div><p>获取每一帧的百分比和值， 如果是颜色值的话，会转换为颜色数组，如果所有的关键帧的值都一样，会退出整个函数。</p> <p>这样的话就解释了，为什么 clip 有可能为空</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 每个关键帧的百分比</span>
<span class="token keyword">var</span> kfPercents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 每个关键帧的值</span>
<span class="token keyword">var</span> kfValues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 上一个关键帧的值</span>
<span class="token keyword">var</span> prevValue <span class="token operator">=</span> keyframes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token comment">// 是不是所有的值都一样</span>
<span class="token keyword">var</span> isAllValueEqual <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> trackLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kfPercents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>keyframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time <span class="token operator">/</span> trackMaxTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Assume value is a color when it is a string</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> keyframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

    <span class="token comment">// 检查值是否相等，深度检查值是否为数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isValueArray <span class="token operator">&amp;&amp;</span> <span class="token function">isArraySame</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> prevValue<span class="token punctuation">,</span> arrDim<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>isValueArray <span class="token operator">&amp;&amp;</span> value <span class="token operator">===</span> prevValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isAllValueEqual <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    prevValue <span class="token operator">=</span> value<span class="token punctuation">;</span>

    <span class="token comment">// 尝试将字符串转换为颜色数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> colorArray <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>colorArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> colorArray<span class="token punctuation">;</span>
            isValueColor <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            isValueString <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    kfValues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forceAnimate <span class="token operator">&amp;&amp;</span> isAllValueEqual<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修复非数字问题，包括数组</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> lastValue <span class="token operator">=</span> kfValues<span class="token punctuation">[</span>trackLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// Polyfill array and NaN value</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> trackLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fillArr</span><span class="token punctuation">(</span>kfValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> lastValue<span class="token punctuation">,</span> arrDim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>kfValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>lastValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isValueString <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isValueColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kfValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> lastValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
isValueArray <span class="token operator">&amp;&amp;</span> <span class="token function">fillArr</span><span class="token punctuation">(</span><span class="token function">getter</span><span class="token punctuation">(</span>animator<span class="token punctuation">.</span>_target<span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">,</span> lastValue<span class="token punctuation">,</span> arrDim<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>声明 Clip 中的 onframe 回调函数， 针对回调函数中的内容，一会看</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> lastFrame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> lastFramePercent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> start<span class="token punctuation">;</span>
<span class="token keyword">var</span> w<span class="token punctuation">;</span>
<span class="token keyword">var</span> p0<span class="token punctuation">;</span>
<span class="token keyword">var</span> p1<span class="token punctuation">;</span>
<span class="token keyword">var</span> p2<span class="token punctuation">;</span>
<span class="token keyword">var</span> p3<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isValueColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> rgba <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">onframe</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> percent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> frame<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>percent <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>percent <span class="token operator">&lt;</span> lastFramePercent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Start from next key</span>
        <span class="token comment">// PENDING start from lastFrame ?</span>
        start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>lastFrame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> trackLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>frame <span class="token operator">=</span> start<span class="token punctuation">;</span> frame <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> frame<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>kfPercents<span class="token punctuation">[</span>frame<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> percent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        frame <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> trackLen <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>frame <span class="token operator">=</span> lastFrame<span class="token punctuation">;</span> frame <span class="token operator">&lt;</span> trackLen<span class="token punctuation">;</span> frame<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>kfPercents<span class="token punctuation">[</span>frame<span class="token punctuation">]</span> <span class="token operator">&gt;</span> percent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        frame <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>frame <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> trackLen <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    lastFrame <span class="token operator">=</span> frame<span class="token punctuation">;</span>
    lastFramePercent <span class="token operator">=</span> percent<span class="token punctuation">;</span>

    <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token punctuation">(</span>kfPercents<span class="token punctuation">[</span>frame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> kfPercents<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        w <span class="token operator">=</span> <span class="token punctuation">(</span>percent <span class="token operator">-</span> kfPercents<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> range<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useSpline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p1 <span class="token operator">=</span> kfValues<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">;</span>
        p0 <span class="token operator">=</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> frame <span class="token operator">:</span> frame <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">&gt;</span> trackLen <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">?</span> trackLen <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> frame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        p3 <span class="token operator">=</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">&gt;</span> trackLen <span class="token operator">-</span> <span class="token number">3</span> <span class="token operator">?</span> trackLen <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> frame <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">catmullRomInterpolateArray</span><span class="token punctuation">(</span>
                p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> w<span class="token punctuation">,</span> w <span class="token operator">*</span> w<span class="token punctuation">,</span> w <span class="token operator">*</span> w <span class="token operator">*</span> w<span class="token punctuation">,</span>
                <span class="token function">getter</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                arrDim
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                value <span class="token operator">=</span> <span class="token function">catmullRomInterpolateArray</span><span class="token punctuation">(</span>
                    p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> w<span class="token punctuation">,</span> w <span class="token operator">*</span> w<span class="token punctuation">,</span> w <span class="token operator">*</span> w <span class="token operator">*</span> w<span class="token punctuation">,</span>
                    rgba<span class="token punctuation">,</span> <span class="token number">1</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> <span class="token function">rgba2String</span><span class="token punctuation">(</span>rgba<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// String is step(0.5)</span>
                <span class="token keyword">return</span> <span class="token function">interpolateString</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                value <span class="token operator">=</span> <span class="token function">catmullRomInterpolate</span><span class="token punctuation">(</span>
                    p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> w<span class="token punctuation">,</span> w <span class="token operator">*</span> w<span class="token punctuation">,</span> w <span class="token operator">*</span> w <span class="token operator">*</span> w
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">setter</span><span class="token punctuation">(</span>
                target<span class="token punctuation">,</span>
                propName<span class="token punctuation">,</span>
                value
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">interpolateArray</span><span class="token punctuation">(</span>
                kfValues<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">,</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span>
                <span class="token function">getter</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                arrDim
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">interpolateArray</span><span class="token punctuation">(</span>
                    kfValues<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">,</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span>
                    rgba<span class="token punctuation">,</span> <span class="token number">1</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> <span class="token function">rgba2String</span><span class="token punctuation">(</span>rgba<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isValueString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// String is step(0.5)</span>
                <span class="token keyword">return</span> <span class="token function">interpolateString</span><span class="token punctuation">(</span>kfValues<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">,</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                value <span class="token operator">=</span> <span class="token function">interpolateNumber</span><span class="token punctuation">(</span>kfValues<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">,</span> kfValues<span class="token punctuation">[</span>frame <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">setter</span><span class="token punctuation">(</span>
                target<span class="token punctuation">,</span>
                propName<span class="token punctuation">,</span>
                value
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>实例化 Clip 并且返回</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">var</span> clip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Clip</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    target<span class="token operator">:</span> animator<span class="token punctuation">.</span>_target<span class="token punctuation">,</span>
    life<span class="token operator">:</span> trackMaxTime<span class="token punctuation">,</span>
    loop<span class="token operator">:</span> animator<span class="token punctuation">.</span>_loop<span class="token punctuation">,</span>
    delay<span class="token operator">:</span> animator<span class="token punctuation">.</span>_delay<span class="token punctuation">,</span>
    onframe<span class="token operator">:</span> onframe<span class="token punctuation">,</span>
    ondestroy<span class="token operator">:</span> oneTrackDone
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>easing <span class="token operator">&amp;&amp;</span> easing <span class="token operator">!==</span> <span class="token string">'spline'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clip<span class="token punctuation">.</span>easing <span class="token operator">=</span> easing<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> clip<span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zrender/animate/Animatable.html" class="prev">
        Animatable
      </a></span> <span class="next"><a href="/zrender/animate/Clip.html">
        Clip
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/zrender/assets/js/app.67d98c5f.js" defer></script><script src="/zrender/assets/js/2.c8ceaaf2.js" defer></script><script src="/zrender/assets/js/10.4ddc04a1.js" defer></script>
  </body>
</html>
